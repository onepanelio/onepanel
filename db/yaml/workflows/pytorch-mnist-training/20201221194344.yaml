# source: https://github.com/onepanelio/templates/blob/master/workflows/pytorch-mnist-training/
entrypoint: main
arguments:
  parameters:
    - name: source
      value: https://github.com/onepanelio/pytorch-examples.git
    - name: command
      value: "python mnist/main.py --epochs=1"
    - displayName: Node pool
      hint: Name of node pool or group to run this workflow task
      type: select.nodepool
      name: sys-node-pool
      value: {{.DefaultNodePoolOption}}
      visibility: public
      required: true
volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 2Gi
  - metadata:
      name: output
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: 2Gi
templates:
  - name: main
    dag:
      tasks:
        - name: train-model
          template: pytorch
  - name: pytorch
    inputs:
      artifacts:
        - name: src
          path: /mnt/src
          git:
            repo: "{{workflow.parameters.source}}"
    outputs:
      artifacts:
        - name: model
          path: /mnt/output
          optional: true
          archive:
            none: {}
    container:
      image: pytorch/pytorch:latest
      command: [sh,-c]
      args: ["{{workflow.parameters.command}}"]
      workingDir: /mnt/src
      volumeMounts:
        - name: data
          mountPath: /mnt/data
        - name: output
          mountPath: /mnt/output
